/**!
* ColtJS Framework
* @version 1.0.1
* @license MIT-License <https://raw.github.com/Fluidbyte/ColtJS/master/LICENSE>
* Copyright (c) 2013)
**/
define(function(){"use strict";var a={routes:{},scope:{},dependencies:{},models:{},requests:{},init:function(){var a,b,c,d=this;window.Colt=this,require(this.modules,function(){for(b=0,c=arguments.length;c>b;b++)a=d.modules[b].split("/").pop(),d.scope[a]=arguments[b],d.scope[a].mid=a,d.scope[a].el=document.querySelectorAll("[data-view='"+a+"']"),"undefined"!=typeof jQuery&&(d.scope[a].$el=jQuery("[data-view='"+a+"']")),d.scope[a].forEachEl=d.forEachEl;d.router()}),Function.prototype.bind||this.polyfill_bind()},router:function(){var a,b,c=window.location.hash,d=this;for(a in this.scope)if(this.scope.hasOwnProperty(a))for(b in this.scope[a].routes)this.routes.hasOwnProperty(b)?this.routes[b].push([a,this.scope[a].routes[b]]):this.routes[b]=[[a,this.scope[a].routes[b]]];this.loadUrl(c),window.onhashchange=function(){d.loadUrl(window.location.hash)}},loadUrl:function(a){var b,c,d,e,f,g,h,i,j,k=this,l=!1,m={};if(a=a.replace("#!/",""),"/"===a.substr(-1)&&(a=a.substr(0,a.length-1)),a=a.split("?"),a[1]&&(l=a[1]),a=a[0].split("/"),a.length>0)for(f=1,g=a.length;g>f;f++)m[f-1]=a[f];if(l)for(b=l.split("&"),f=0,g=b.length;g>f;f++)j=b[f].split("="),m[j[0]]=j[1];k.current_route=a[0],k.url_data=m;for(e in k.routes)if(k.routes.hasOwnProperty(e))for(h=0,i=k.routes[e].length;i>h;h++)d=k.routes[e][h][0],a[0]===e||"*"===e?c!==d&&(c=d,k.processor(d,k.routes[e][h][1],m)):k.unrender(d)},processor:function(a,b,c){var d=this.scope[a],e=this;d.loaded=!0,d.hasOwnProperty("template")?e.loadDependencies(d,function(){d[b](c)}):e.ajax({url:"templates/"+d.mid+".tpl",type:"GET",success:function(a){d.template=a,e.loadDependencies(d,function(){d[b](c)})},error:function(){console.log("Could not load template for "+d.mid)}})},loadDependencies:function(a,b){var c,d,e,f,g,h=this,i=[],j=[];if(a.hasOwnProperty("dependencies")){for(e in a.dependencies)a.dependencies.hasOwnProperty(e)&&(f=e,g=a.dependencies[e],h.dependencies.hasOwnProperty(g)?a[f]=h.dependencies[g]:(i.push(f),j.push(g)));require(j,function(){for(c=0,d=arguments.length;d>c;c++)a[i[c]]=arguments[c],h.dependencies[j[c]]=arguments[c];b&&"function"==typeof b&&b(a)})}else b&&"function"==typeof b&&b(a)},render:function(a,b){var c,d,e,f,g,h=this,i=a.template;for(c=function(a,c){return b[c]},e=a.el.length,g=0;e>g;g++)f=a.el[g],d=i.replace(/\{\{([^}]+)\}\}/g,c),f.innerHTML=d,f.style.display="block";h.delegateEvents(a.events,a)},unrender:function(a){var b,c,d;for(c=document.querySelectorAll("[data-view='"+a+"']"),b=0,d=c.length;d>b;b++)c[b].innerHTML="",c[b].style.display="none"},access:function(a,b){var c=this,d=this.scope[a];d.hasOwnProperty("loaded")?b&&"function"==typeof b&&b(d):c.loadDependencies(d,function(a){a.loaded=!0,b&&"function"==typeof b&&b(a)})},navigate:function(a){var b,c=window.location,d=c.pathname.replace(/[^\/]$/,"$&"),e=this;return b=a.length?d+c.search+"#!/"+a:d+c.search,history.pushState?(history.pushState(null,document.title,b),e.loadUrl(a)):c.replace(d+b),!0},delegateEvents:function(a,b){var c,d,e,f,g,h,i,j,k=/^(\S+)\s*(.*)$/,l=this;if(a)for(h in a)if(a.hasOwnProperty(h))for(c=a[h],d=h.match(k),e=d[1],f=d[2],g=document.querySelectorAll("[data-view='"+b.mid+"'] "+f),j=0,i=g.length;i>j;j++)l.bindEvent(g[j],e,b[c].bind(b),!0)},bindEvent:function(a,b,c,d){d=d||!1,a.addEventListener?a.addEventListener(b,function(a){d&&(a.preventDefault?a.preventDefault():a.returnValue=!1),c(a)},!1):a.attachEvent("on"+b,function(a){d&&(a.preventDefault?a.preventDefault():a.returnValue=!1),c(a)})},model:function(){var a,b,c,d=this;if("object"==typeof arguments[0]){if(c=arguments[0],c.url=c.url||!1,c.onchange=c.onchange||!1,"string"==typeof c.name&&""!==c.name)return d.models[c.name]={data:c.data,get:d.sync.bind(d,c.name,"GET"),put:d.sync.bind(d,c.name,"PUT"),post:d.sync.bind(d,c.name,"POST"),"delete":d.sync.bind(d,c.name,"DELETE")},c.url&&(d.models[c.name].url=c.url),c.onchange&&(d.models[c.name].onchange=c.onchange),c.onsync&&(d.models[c.name].onsync=c.onsync),d.models[c.name];throw new Error("Cannot create a null model")}return 2!==arguments.length?(a=arguments[0],b=d.models[a]):(a=arguments[0],b=d.models[a],"object"==typeof arguments[1]&&null!==arguments[1]?(b.data=arguments[1],b.hasOwnProperty("onchange")&&b.onchange(b.data),d.publish("model_"+a+"_change",b.data)):delete d.models[a],void 0)},sync:function(a,b){var c=this.models[a],d={},e=this,f=this.parseURL(c.url,c.data),g=c.data,h={url:f,type:b,data:g,qsData:!1,success:function(f){d.status="success",d.data=f,"GET"===b&&e.model(a,JSON.parse(f)),"DELETE"===b&&e.model(a,null),c.hasOwnProperty("onsync")&&c.onsync(d),e.publish("model_"+a+"_sync",d)},error:function(b){throw d.status="error",d.data=b,c.hasOwnProperty("onsync")&&c.onsync(d),e.publish("model_"+a+"_sync",d),new Error("Model Sync Error: [req] : "+b)}};e.ajax(h)},request:function(a,b){var c=this;return"object"==typeof b&&null!==b?(c.requests[a]={params:b,call:c.callRequest.bind(c,a)},c.requests[a]):"undefined"==typeof data?c.requests[a]:(null===b&&c.requests.hasOwnProperty(a)&&delete c.requests[a],void 0)},callRequest:function(a,b,c,d){var e,f=this,g={};if(c=c||!1,d=d||!1,f.requests.hasOwnProperty(a)){for(e in f.requests[a].params)f.requests[a].params.hasOwnProperty(e)&&(g[e]=f.requests[a].params[e]);g.url=f.parseURL(g.url,b),g.data=b,c&&"function"==typeof c&&(g.success=c),d&&"function"==typeof d&&(g.error=d),f.ajax(g)}},parseURL:function(a,b){return a.replace(/\{([^}]+)\}/g,function(a,c){return b[c]})},ajax:function(){function a(a){var c=b.url.split("?");b.url+=1!==c.length?"&"+a:"?"+a}var b={};if(1===arguments.length?b=arguments[0]:(b=arguments[1],b.url=arguments[0]),b.request=!1,b.type=b.type||"GET",b.data=b.data||null,b.qsData=b.qsData||!b.hasOwnProperty("qsData")?!0:!1,b.cache=b.cache||!b.hasOwnProperty("cache")?!0:!1,b.async=b.async||!b.hasOwnProperty("async")?!0:!1,b.success=b.success&&"function"==typeof b.success?b.success:!1,b.error=b.error&&"function"==typeof b.error?b.error:!1,b.data){var c,d,e=0,f=b.data;for(var g in f)f.hasOwnProperty(g)&&(c=encodeURIComponent(g),d=encodeURIComponent(f[g]),0===e?b.data=c+"="+d:b.data+="&"+c+"="+d,e++);b.data=b.data}if(b.data&&"GET"===b.type.toUpperCase()&&b.qsData&&a(b.data),b.cache||a((new Date).getTime()),window.XMLHttpRequest)b.request=new XMLHttpRequest;else{if(!window.ActiveXObject)return!1;b.request=new ActiveXObject("Microsoft.XMLHTTP")}b.request.onreadystatechange=function(){var a;if(4===b.request.readyState)if(200===b.request.status){if(b.success){try{a=JSON.parse(b.request.responseText)}catch(c){a=b.request.responseText}b.success(a,b.request)}}else b.error&&b.error(b.request)},b.request.open(b.type,b.url,b.async),("POST"===b.type.toUpperCase()||"PUT"===b.type.toUpperCase())&&b.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),b.request.send(b.data)},store:function(a,b){var c,d=this,e=!1;if(localStorage&&(e=!0),"undefined"!=typeof b&&null!==b&&("object"==typeof b&&(b=JSON.stringify(b)),e?localStorage.setItem(a,b):d.createCookie(a,b,30)),"undefined"==typeof b){c=e?localStorage.getItem(a):d.readCookie(a);try{c=JSON.parse(c)}catch(f){c=c}return c}null===b&&(e?localStorage.removeItem(a):d.createCookie(a,"",-1))},createCookie:function(a,b,c){var d,e=new Date;e.setTime(e.getTime()+1e3*60*60*24*c),d="; expires="+e.toGMTString(),document.cookie=a+"="+b+d+"; path=/"},readCookie:function(a){var b,c,d,e=a+"=",f=document.cookie.split(";");for(b=0,c=f.length;c>b;b++){for(d=f[b];" "===d.charAt(0);)d=d.substring(1,d.length);if(0===d.indexOf(e))return d.substring(e.length,d.length)}return null},topics:{},topic_id:0,publish:function(a,b){var c=this;return c.topics.hasOwnProperty(a)?(setTimeout(function(){var d,e=c.topics[a];if(!e.length)return!1;for(d=e.length;d--;)e[d].fn(b)},0),!0):!1},subscribe:function(a,b){var c,d,e=this,f=++this.topic_id;for(e.topics[a]||(e.topics[a]=[]),d=0,c=e.topics[a].length;c>d;d++)if(e.topics[a][d].fn.toString()===b.toString())return e.topics[a][d].id;return e.topics[a].push({id:f,fn:b}),f},unsubscribe:function(a){var b,c,d,e=this;for(b in e.topics)if(e.topics.hasOwnProperty(b))for(c=0,d=e.topics[b].length;d>c;c++)if(e.topics[b][c].id===a)return e.topics[b].splice(c,1),a;return!1},polyfill_bind:function(){Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=[].slice,c=b.call(arguments,1),d=this,e=function(){},f=function(){return d.apply(this instanceof e?this:a||{},c.concat(b.call(arguments)))};return f.prototype=this.prototype,f}},forEachEl:function(a){if("function"!=typeof a)throw new Error("Callback must be a function");for(var b=-1,c=this.el.length;++b<c&&a(b,this.el[b],this.el)!==!1;);}};return a});