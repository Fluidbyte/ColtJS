/**
 * ColtJS Framework
 *
 * @version 0.5.1
 * @license MIT-License <http://opensource.org/licenses/MIT>
 *
 * Copyright (c) 2013 ColtJS
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do
 * so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE
 */
define(function(){var Colt={routes:{},scope:{},dependencies:{},init:function(){var module,_this=this;window.Colt=this;require(this.modules,function(){for(var i=0,max=arguments.length;i<max;i++){module=_this.modules[i].split("/").pop();_this.scope[module]=arguments[i];_this.scope[module].mid=module;_this.scope[module].el=document.getElementById(module);if(typeof jQuery!=="undefined"){_this.scope[module].$el=jQuery("#"+module)}}_this.router()});if(!Function.prototype.bind){this.polyfill_bind()}},router:function(){var cur_route=window.location.hash,_this=this;for(var module in this.scope){if(this.scope.hasOwnProperty(module)){for(var route in this.scope[module].routes){if(!this.routes.hasOwnProperty(route)){this.routes[route]=[[module,this.scope[module].routes[route]]]}else{this.routes[route].push([module,this.scope[module].routes[route]])}}}}this.loadUrl(cur_route);window.onhashchange=function(){_this.loadUrl(window.location.hash)}},loadUrl:function(fragment){var el_lock,module_name,url_data={};fragment=fragment.replace("#!/","");fragment=fragment.split("?");if(fragment[1]){var qs=fragment[1].split("&");for(var i=0,max=qs.length;i<max;i++){var bits=qs[i].split("=");url_data[bits[0]]=bits[1]}}this.current_route=fragment[0];this.url_data=url_data;for(var route in this.routes){if(this.routes.hasOwnProperty(route)){for(var _i=0,_max=this.routes[route].length;_i<_max;_i++){module_name=this.routes[route][_i][0];if(fragment[0]===route||route==="*"){if(el_lock!==module_name){el_lock=module_name;this.processor(module_name,this.routes[route][_i][1],url_data)}}else{this.unrender(module_name)}}}}},processor:function(module,route_fn,url_data){var scope=this.scope[module],_this=this;scope.loaded=true;if(!scope.hasOwnProperty("template")){this.ajax({url:"templates/"+scope.mid+".tpl",type:"GET",success:function(data){scope.template=data;_this.loadDependencies(scope,function(){scope[route_fn](url_data)})},error:function(){console.error("Error Loading "+scope.mid+".tpl")}})}else{_this.loadDependencies(scope,function(){scope[route_fn](url_data)})}},loadDependencies:function(scope,callback){var _this=this,dep_name,dep_src,arr_dep_name=[],arr_dep_src=[];if(scope.hasOwnProperty("dependencies")){for(var dep in scope.dependencies){if(scope.dependencies.hasOwnProperty(dep)){dep_name=dep;dep_src=scope.dependencies[dep];if(_this.dependencies.hasOwnProperty(dep_src)){scope[dep_name]=_this.dependencies[dep_src]}else{arr_dep_name.push(dep_name);arr_dep_src.push(dep_src)}}}require(arr_dep_src,function(){for(var i=0,max=arguments.length;i<max;i++){scope[arr_dep_name[i]]=arguments[i];_this.dependencies[arr_dep_src[i]]=arguments[i]}if(callback&&typeof callback==="function"){callback(scope)}})}else{if(callback&&typeof callback==="function"){callback(scope)}}},render:function(scope,data){var template=scope.template,el=document.getElementById(scope.mid),rendered=template.replace(/\{\{([^}]+)\}\}/g,function(i,match){return data[match]});el.innerHTML=rendered;el.style.display="block";this.delegateEvents(scope.events,scope)},unrender:function(module_name){document.getElementById(module_name).innerHTML="";document.getElementById(module_name).style.display="none"},access:function(module,callback){var _this=this,scope=this.scope[module];if(!scope.hasOwnProperty("loaded")){_this.loadDependencies(scope,function(scope){scope.loaded=true;if(callback&&typeof callback==="function"){callback(scope)}})}else{if(callback&&typeof callback==="function"){callback(scope)}}},navigate:function(fragment){var location=window.location,root=location.pathname.replace(/[^\/]$/,"$&"),_this=this;if(history.pushState){history.pushState(null,document.title,root+location.search+"#!/"+fragment);_this.loadUrl(fragment)}else{location.replace(root+location.search+"#!/"+fragment)}return true},delegateEvents:function(events,scope){var method,match,event_name,selector,nodes,_this=this;if(!events){return}var delegateEventSplitter=/^(\S+)\s*(.*)$/;for(var key in events){if(events.hasOwnProperty(key)){method=events[key];match=key.match(delegateEventSplitter);event_name=match[1];selector=match[2];nodes=document.querySelectorAll("#"+scope.mid+" "+selector);for(var i=0,max=nodes.length;i<max;i++){_this.bindEvent(nodes[i],event_name,scope[method].bind(scope),true)}}}},bindEvent:function(el,evt,fn,pdef){pdef=pdef||false;if(el.addEventListener){el.addEventListener(evt,function(event){if(pdef){event.preventDefault?event.preventDefault():event.returnValue=false}fn(event)},false)}else{el.attachEvent("on"+evt,function(event){if(pdef){event.preventDefault?event.preventDefault():event.returnValue=false}fn(event)})}},ajax:function(){var xhr={};if(arguments.length===1){xhr=arguments[0]}else{xhr=arguments[1];xhr.url=arguments[0]}xhr.request=false;xhr.type=xhr.type||"GET";xhr.data=xhr.data||null;if(xhr.cache||!xhr.hasOwnProperty("cache")){xhr.cache=true}else{xhr.cache=false}if(xhr.async||!xhr.hasOwnProperty("async")){xhr.async=true}else{xhr.async=false}if(xhr.success&&typeof xhr.success==="function"){xhr.success=xhr.success}else{xhr.success=false}if(xhr.error&&typeof xhr.error==="function"){xhr.error=xhr.error}else{xhr.error=false}if(xhr.data){var param_count=0,name,value,tmp_data=xhr.data;for(var param in tmp_data){if(tmp_data.hasOwnProperty(param)){name=encodeURIComponent(param);value=encodeURIComponent(tmp_data[param]);if(param_count===0){xhr.data=name+"="+value}else{xhr.data+="&"+name+"="+value}param_count++}}xhr.data=xhr.data}function formatURL(data){var url_split=xhr.url.split("?");if(url_split.length!==1){xhr.url+="&"+data}else{xhr.url+="?"+data}}if(xhr.data&&xhr.type.toUpperCase()==="GET"){formatURL(xhr.data)}if(!xhr.cache){formatURL((new Date).getTime())}if(window.XMLHttpRequest){xhr.request=new XMLHttpRequest}else if(window.ActiveXObject){xhr.request=new ActiveXObject("Microsoft.XMLHTTP")}else{return false}xhr.request.onreadystatechange=function(){if(xhr.request.readyState===4){if(xhr.request.status===200){if(xhr.success){xhr.success(xhr.request.responseText,xhr.request)}}else{if(xhr.error){xhr.error(xhr.request)}}}};xhr.request.open(xhr.type,xhr.url,xhr.async);if(xhr.type.toUpperCase()==="POST"){xhr.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}xhr.request.send(xhr.data)},store:function(key,value){var lsSupport=false;if(localStorage){lsSupport=true}if(typeof value!=="undefined"&&value!==null){if(lsSupport){localStorage.setItem(key,value)}else{this.createCookie(key,value,30)}}if(typeof value==="undefined"){if(lsSupport){return localStorage.getItem(key)}else{return this.readCookie(key)}}if(value===null){if(lsSupport){localStorage.removeItem(key)}else{this.createCookie(key,"",-1)}}},createCookie:function(key,value,exp){var date=new Date,expires;date.setTime(date.getTime()+exp*24*60*60*1e3);expires="; expires="+date.toGMTString();document.cookie=key+"="+value+expires+"; path=/"},readCookie:function(key){var nameEQ=key+"=",ca=document.cookie.split(";");for(var i=0,max=ca.length;i<max;i++){var c=ca[i];while(c.charAt(0)===" "){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)===0){return c.substring(nameEQ.length,c.length)}}return null},topics:{},topic_id:0,publish:function(topic,args){var _this=this;if(!this.topics.hasOwnProperty(topic)){return false}setTimeout(function(){var subscribers=_this.topics[topic],len;if(subscribers.length){len=subscribers.length}else{return false}while(len--){subscribers[len].fn(args)}},0);return true},subscribe:function(topic,fn){var id=++this.topic_id;if(!this.topics[topic]){this.topics[topic]=[]}this.topics[topic].push({id:id,fn:fn});return id},unsubscribe:function(token){for(var topic in this.topics){if(this.topics.hasOwnProperty(topic)){for(var i=0,max=this.topics[topic].length;i<max;i++){if(this.topics[topic][i].id===token){this.topics[topic].splice(i,1);return token}}}}return false},polyfill_bind:function(){Function.prototype.bind=function(obj){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var slice=[].slice,args=slice.call(arguments,1),self=this,nop=function(){},bound=function(){return self.apply(this instanceof nop?this:obj||{},args.concat(slice.call(arguments)))};bound.prototype=this.prototype;return bound}}};return Colt});