/**
 * ColtJS Framework
 *
 * @version 0.7.2
 * @license MIT-License <http://opensource.org/licenses/MIT>
 *
 * Copyright (c) 2013 ColtJS
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do
 * so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE
 */
define(function(){var a={routes:{},scope:{},dependencies:{},models:{},requests:{},init:function(){var b,c=this;window.Colt=this;require(this.modules,function(){for(var e=0,d=arguments.length;e<d;e++){b=c.modules[e].split("/").pop();c.scope[b]=arguments[e];c.scope[b].mid=b;c.scope[b].el=document.getElementById(b);if(typeof jQuery!=="undefined"){c.scope[b].$el=jQuery("#"+b)}}c.router()});if(!Function.prototype.bind){this.polyfill_bind()}},router:function(){var e=window.location.hash,d=this;for(var c in this.scope){if(this.scope.hasOwnProperty(c)){for(var b in this.scope[c].routes){if(!this.routes.hasOwnProperty(b)){this.routes[b]=[[c,this.scope[c].routes[b]]]}else{this.routes[b].push([c,this.scope[c].routes[b]])}}}}this.loadUrl(e);window.onhashchange=function(){d.loadUrl(window.location.hash)}},loadUrl:function(g){var e=this,f,h,m=false,d,j,n,b={};g=g.replace("#!/","");if(g.substr(-1)=="/"){g=g.substr(0,g.length-1)}g=g.split("?");if(g[1]){m=g[1]}g=g[0].split("/");if(g.length>0){for(d=1,j=g.length;d<j;d++){b[d-1]=g[d]}}if(m){var l=m.split("&");for(d=0,j=l.length;d<j;d++){n=l[d].split("=");b[n[0]]=n[1]}}e.current_route=g[0];e.url_data=b;for(var k in e.routes){if(e.routes.hasOwnProperty(k)){for(var c=0,o=e.routes[k].length;c<o;c++){h=e.routes[k][c][0];if(g[0]===k||k==="*"){if(f!==h){f=h;e.processor(h,e.routes[k][c][1],b)}}else{e.unrender(h)}}}}},processor:function(c,f,b){var d=this.scope[c],e=this;d.loaded=true;if(!d.hasOwnProperty("template")){e.ajax({url:"templates/"+d.mid+".tpl",type:"GET",success:function(g){d.template=g;e.loadDependencies(d,function(){d[f](b)})},error:function(){console.error("Error Loading "+d.mid+".tpl")}})}else{e.loadDependencies(d,function(){d[f](b)})}},loadDependencies:function(d,i){var h=this,f,e,b=[],c=[];if(d.hasOwnProperty("dependencies")){for(var g in d.dependencies){if(d.dependencies.hasOwnProperty(g)){f=g;e=d.dependencies[g];if(h.dependencies.hasOwnProperty(e)){d[f]=h.dependencies[e]}else{b.push(f);c.push(e)}}}require(c,function(){for(var k=0,j=arguments.length;k<j;k++){d[b[k]]=arguments[k];h.dependencies[c[k]]=arguments[k]}if(i&&typeof i==="function"){i(d)}})}else{if(i&&typeof i==="function"){i(d)}}},render:function(d,e){var g=this,c=d.template,b=document.getElementById(d.mid),f=c.replace(/\{\{([^}]+)\}\}/g,function(j,h){return e[h]});b.innerHTML=f;b.style.display="block";g.delegateEvents(d.events,d)},unrender:function(b){document.getElementById(b).innerHTML="";document.getElementById(b).style.display="none"},access:function(b,e){var d=this,c=this.scope[b];if(!c.hasOwnProperty("loaded")){d.loadDependencies(c,function(f){f.loaded=true;if(e&&typeof e==="function"){e(f)}})}else{if(e&&typeof e==="function"){e(c)}}},navigate:function(e){var c=window.location,b=c.pathname.replace(/[^\/]$/,"$&"),f=this,d;if(e.length){d=b+c.search+"#!/"+e}else{d=b+c.search}if(history.pushState){history.pushState(null,document.title,d);f.loadUrl(e)}else{c.replace(b+d)}return true},delegateEvents:function(n,m){var b,f,g,d,c,h=this;if(!n){return}var j=/^(\S+)\s*(.*)$/;for(var l in n){if(n.hasOwnProperty(l)){b=n[l];f=l.match(j);g=f[1];d=f[2];c=document.querySelectorAll("#"+m.mid+" "+d);for(var e=0,k=c.length;e<k;e++){h.bindEvent(c[e],g,m[b].bind(m),true)}}}},bindEvent:function(e,c,d,b){b=b||false;if(e.addEventListener){e.addEventListener(c,function(f){if(b){f.preventDefault?f.preventDefault():f.returnValue=false}d(f)},false)}else{e.attachEvent("on"+c,function(f){if(b){f.preventDefault?f.preventDefault():f.returnValue=false}d(f)})}},model:function(){var e=this,c,b,d;if(typeof arguments[0]==="object"){d=arguments[0];d.url=d.url||false;d.onchange=d.onchange||false;if(typeof d.name==="string"&&d.name!==""){e.models[d.name]={data:d.data,get:e.sync.bind(e,d.name,"GET"),put:e.sync.bind(e,d.name,"PUT"),post:e.sync.bind(e,d.name,"POST"),"delete":e.sync.bind(e,d.name,"DELETE")};if(d.url){e.models[d.name].url=d.url}if(d.onchange){e.models[d.name].onchange=d.onchange}if(d.onsync){e.models[d.name].onsync=d.onsync}return e.models[d.name]}else{console.error("CAN NOT CREATE NULL MODEL")}}else{if(arguments.length===2){c=arguments[0];b=e.models[c];if(typeof arguments[1]==="object"&&arguments[1]!==null){b.data=arguments[1];if(b.hasOwnProperty("onchange")){b.onchange(b.data)}e.publish("model_"+c+"_change",b.data)}else{delete e.models[c]}}else{c=arguments[0];b=e.models[c];return b}}},sync:function(e,i){var d=this.models[e],h={};var g=this,c=this.parseURL(d.url,d.data),f=d.data,b={url:c,type:i,data:f,qsData:false,success:function(j){h.status="success";h.data=j;if(i==="GET"){g.model(e,JSON.parse(j))}if(i==="DELETE"){g.model(e,null)}if(d.hasOwnProperty("onsync")){d.onsync(h)}g.publish("model_"+e+"_sync",h)},error:function(j){h.status="error";h.data=j;if(d.hasOwnProperty("onsync")){d.onsync(h)}g.publish("model_"+e+"_sync",h);console.error("MODEL SYNC ERROR: ",j)}};g.ajax(b)},request:function(b,c){var d=this;if(typeof c==="object"&&c!==null){d.requests[b]={params:c,call:d.callRequest.bind(d,b)};return d.requests[b]}if(typeof data==="undefined"){return d.requests[b]}if(c===null){if(d.requests.hasOwnProperty(b)){delete d.requests[b]}}},callRequest:function(c,e,g,b){var h=this,d={};g=g||false;b=b||false;if(h.requests.hasOwnProperty(c)){for(var f in h.requests[c].params){d[f]=h.requests[c].params[f]}d.url=h.parseURL(d.url,e);d.data=e;if(g&&typeof g==="function"){d.success=g}if(b&&typeof b==="function"){d.error=b}h.ajax(d)}},parseURL:function(b,c){return b.replace(/\{([^}]+)\}/g,function(e,d){return c[d]})},ajax:function(){var h={};if(arguments.length===1){h=arguments[0]}else{h=arguments[1];h.url=arguments[0]}h.request=false;h.type=h.type||"GET";h.data=h.data||null;if(h.qsData||!h.hasOwnProperty("qsData")){h.qsData=true}else{h.qsData=false}if(h.cache||!h.hasOwnProperty("cache")){h.cache=true}else{h.cache=false}if(h.async||!h.hasOwnProperty("async")){h.async=true}else{h.async=false}if(h.success&&typeof h.success==="function"){h.success=h.success}else{h.success=false}if(h.error&&typeof h.error==="function"){h.error=h.error}else{h.error=false}if(h.data){var f=0,b,e,c=h.data;for(var g in c){if(c.hasOwnProperty(g)){b=encodeURIComponent(g);e=encodeURIComponent(c[g]);if(f===0){h.data=b+"="+e}else{h.data+="&"+b+"="+e}f++}}h.data=h.data}function d(j){var i=h.url.split("?");if(i.length!==1){h.url+="&"+j}else{h.url+="?"+j}}if(h.data&&h.type.toUpperCase()==="GET"&&h.qsData){d(h.data)}if(!h.cache){d(new Date().getTime())}if(window.XMLHttpRequest){h.request=new XMLHttpRequest()}else{if(window.ActiveXObject){h.request=new ActiveXObject("Microsoft.XMLHTTP")}else{return false}}h.request.onreadystatechange=function(){if(h.request.readyState===4){if(h.request.status===200){if(h.success){h.success(h.request.responseText,h.request)}}else{if(h.error){h.error(h.request)}}}};h.request.open(h.type,h.url,h.async);if(h.type.toUpperCase()==="POST"||h.type.toUpperCase()==="PUT"){h.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}h.request.send(h.data)},store:function(b,d){var e=this,c=false;if(localStorage){c=true}if(typeof d!=="undefined"&&d!==null){if(typeof d==="object"){d=JSON.stringify(d)}if(c){localStorage.setItem(b,d)}else{e.createCookie(b,d,30)}}if(typeof d==="undefined"){if(c){return localStorage.getItem(b)}else{return e.readCookie(b)}}if(d===null){if(c){localStorage.removeItem(b)}else{e.createCookie(b,"",-1)}}},createCookie:function(d,e,f){var c=new Date(),b;c.setTime(c.getTime()+(f*24*60*60*1000));b="; expires="+c.toGMTString();document.cookie=d+"="+e+b+"; path=/"},readCookie:function(f){var g=f+"=",d=document.cookie.split(";");for(var e=0,b=d.length;e<b;e++){var h=d[e];while(h.charAt(0)===" "){h=h.substring(1,h.length)}if(h.indexOf(g)===0){return h.substring(g.length,h.length)}}return null},topics:{},topic_id:0,publish:function(c,b){var d=this;if(!d.topics.hasOwnProperty(c)){return false}setTimeout(function(){var f=d.topics[c],e;if(f.length){e=f.length}else{return false}while(e--){f[e].fn(b)}},0);return true},subscribe:function(b,d){var g=this,f=++this.topic_id,c=0,e;if(!g.topics[b]){g.topics[b]=[]}for(c,e=g.topics[b].length;c<e;c++){if(g.topics[b][c].fn.toString()===d.toString()){return g.topics[b][c].id}}g.topics[b].push({id:f,fn:d});return f},unsubscribe:function(e){var f=this,c;for(c in f.topics){if(f.topics.hasOwnProperty(c)){for(var d=0,b=f.topics[c].length;d<b;d++){if(f.topics[c][d].id===e){f.topics[c].splice(d,1);return e}}}}return false},polyfill_bind:function(){Function.prototype.bind=function(e){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var f=[].slice,c=f.call(arguments,1),b=this,g=function(){},d=function(){return b.apply(this instanceof g?this:(e||{}),c.concat(f.call(arguments)))};d.prototype=this.prototype;return d}}};return a});
